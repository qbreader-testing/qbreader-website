import questionStats from"../scripts/auth/question-stats.js";import api from"../scripts/api/index.js";import audio from"../audio/index.js";import CategoryManager from"../../quizbowl/category-manager.js";import{getDropdownValues}from"../scripts/utilities/dropdown-checklist.js";import{arrayToRange,createTossupCard,rangeToArray}from"../scripts/utilities/index.js";import CategoryModal from"../scripts/components/CategoryModal.min.js";import DifficultyDropdown from"../scripts/components/DifficultyDropdown.min.js";import upsertPlayerItem from"../scripts/upsertPlayerItem.js";import{MODE_ENUM}from"../../quizbowl/constants.js";const categoryManager=new CategoryManager;let oldCategories=JSON.stringify(categoryManager.export());const room={difficulties:[],mode:MODE_ENUM.RANDOM,muteList:[],ownerId:"",public:!0,setLength:24,showingOffline:!1},players={};/**
 * userId to player object
 */let BLOCKED_TEAM_BUZZ=!1,PLAYER_TEAM=null,RED_SCORE=0,BLUE_SCORE=0;const ROOM_NAME=decodeURIComponent(window.location.pathname.substring(13));let tossup={},USER_ID=window.localStorage.getItem("USER_ID")||"unknown",username=window.localStorage.getItem("multiplayer-username")||api.getRandomName();const socket=new window.WebSocket(window.location.href.replace("http","ws").split("?")[0]+"?"+new URLSearchParams({...Object.fromEntries(new URLSearchParams(window.location.search)),roomName:ROOM_NAME,userId:USER_ID,username}).toString());window.history.pushState({},"","/multiplayer/"+encodeURIComponent(ROOM_NAME));// Ping server every 30 seconds to prevent socket disconnection
const PING_INTERVAL_ID=setInterval(()=>socket.send(JSON.stringify({type:"ping"})),3e4);socket.onclose=function(a){const{code:b}=a;3e3!==b&&window.alert("Disconnected from server"),clearInterval(PING_INTERVAL_ID)},socket.onmessage=function(a){const b=JSON.parse(a.data);switch(b.type){case"block-team-buzz":return blockTeamBuzz(b);case"buzz":return buzz(b);case"change-team":return teamChange(b);case"chat":return chat(b,!1);case"chat-live-update":return chat(b,!0);case"clear-stats":return clearStats(b);case"confirm-ban":return confirmBan(b);case"connection-acknowledged":return connectionAcknowledged(b);case"connection-acknowledged-query":return connectionAcknowledgedQuery(b);case"connection-acknowledged-tossup":return connectionAcknowledgedTossup(b);case"enforcing-removal":return ackRemovedFromRoom(b);case"end":return next(b);case"end-of-set":return endOfSet(b);case"error":return handleError(b);case"force-username":return forceUsername(b);case"give-answer":return giveAnswer(b);case"give-answer-live-update":return logGiveAnswer(b);case"initiated-vk":return vkInit(b);case"join":return join(b);case"join-team":return joinTeam(b);case"leave":return leave(b);case"lost-buzzer-race":return lostBuzzerRace(b);case"mute-player":return mutePlayer(b);case"next":return next(b);case"no-questions-found":return noQuestionsFound(b);case"no-points-votekick-attempt":return failedVotekickPoints(b);case"owner-change":return ownerChange(b);case"pause":return pause(b);case"reveal-answer":return revealAnswer(b);case"set-categories":return setCategories(b);case"set-difficulties":return setDifficulties(b);case"set-mode":return setMode(b);case"set-packet-numbers":return setPacketNumbers(b);case"set-reading-speed":return setReadingSpeed(b);case"set-set-name":return setSetName(b);case"set-strictness":return setStrictness(b);case"set-username":return setUsername(b);case"set-year-range":return setYearRange(b);case"skip":return next(b);case"start":return next(b);case"successful-vk":return vkHandle(b);case"timer-update":return updateTimerDisplay(b.timeRemaining);case"toggle-controlled":return toggleControlled(b);case"toggle-lock":return toggleLock(b);case"toggle-login-required":return toggleLoginRequired(b);case"toggle-powermark-only":return togglePowermarkOnly(b);case"toggle-public":return togglePublic(b);case"toggle-rebuzz":return toggleRebuzz(b);case"toggle-skip":return toggleSkip(b);case"toggle-standard-only":return toggleStandardOnly(b);case"toggle-timer":return toggleTimer(b);case"update-question":return updateQuestion(b)}};// if a banned/kicked user tries to join a room they were removed from this is the response
function ackRemovedFromRoom({removalType:a}){"kick"===a?window.alert("You were kicked from this room by players, and cannot rejoin it."):window.alert("You were banned from this room by the room owner, and cannot rejoin it."),setTimeout(()=>{window.location.replace("../")},100)}function blockTeamBuzz({team:a}){PLAYER_TEAM===a?(document.getElementById("buzz").disabled=!0,BLOCKED_TEAM_BUZZ=!0,console.log("disabled buzz bc teammate wrong")):console.log("other team no buzz")}function buzz({userId:a,username:b}){console.log(players[a].team),players[a].team===PLAYER_TEAM&&console.log("Your teammate buzzed"),logEventConditionally(b,"buzzed"),document.getElementById("buzz").disabled=!0,document.getElementById("pause").disabled=!0,document.getElementById("next").disabled=!0,document.getElementById("skip").disabled=!0,a===USER_ID&&(document.getElementById("answer-input-group").classList.remove("d-none"),document.getElementById("answer-input").focus())}function chat({message:a,userId:c,username:d},e=!1){if(!room.muteList.includes(c)){if(!e&&""===a)return void document.getElementById("live-chat-"+c).parentElement.remove();if(!e&&a)return document.getElementById("live-chat-"+c).className="",void(document.getElementById("live-chat-"+c).id="");if(document.getElementById("live-chat-"+c))return void(document.getElementById("live-chat-"+c).textContent=a);const f=document.createElement("b");f.textContent=d;const b=document.createElement("span");b.classList.add("text-muted"),b.id="live-chat-"+c,b.textContent=a;const g=document.createElement("li");g.appendChild(f),g.appendChild(document.createTextNode(" ")),g.appendChild(b),document.getElementById("room-history").prepend(g)}}function clearStats({userId:a}){for(const b of["celerity","negs","points","powers","tens","tuh","zeroes"])players[a][b]=0;upsertPlayerItem(players[a],USER_ID,room.ownerId,socket,room.public,room.showingOffline,RED_SCORE,BLUE_SCORE),sortPlayerListGroup(PLAYER_TEAM)}function confirmBan({targetId:a,targetUsername:b}){a===USER_ID?(window.alert("You were banned from this room by the room owner."),setTimeout(()=>{window.location.replace("../")},100)):logEventConditionally(b+" has been banned from this room.")}function connectionAcknowledged({buzzedIn:a,canBuzz:b,isPermanent:c,ownerId:d,mode:e,packetLength:f,players:g,questionProgress:h,team:i,settings:j,setLength:k,userId:l,rscore:m,bscore:n}){RED_SCORE=m,BLUE_SCORE=n,room.public=j.public,room.ownerId=d,room.setLength=k,USER_ID=l,window.localStorage.setItem("USER_ID",USER_ID),document.getElementById("buzz").disabled=!b,"red"===i?PLAYER_TEAM="red":"blue"===i&&(PLAYER_TEAM="blue"),c&&(document.getElementById("category-select-button").disabled=!0,document.getElementById("permanent-room-warning").classList.remove("d-none"),document.getElementById("reading-speed").disabled=!0,document.getElementById("set-strictness").disabled=!0,document.getElementById("set-mode").disabled=!0,document.getElementById("toggle-public").disabled=!0);for(const o of Object.keys(g))g[o].celerity=g[o].celerity.correct.average,players[o]=g[o],console.log(players),upsertPlayerItem(players[o],USER_ID,room.ownerId,socket,room.public,room.showingOffline,RED_SCORE,BLUE_SCORE);sortPlayerListGroup(PLAYER_TEAM),setMode({mode:e}),document.getElementById("packet-length-info").textContent=e===MODE_ENUM.SET_NAME?f:"-";0===h?(document.getElementById("next").textContent="Start",document.getElementById("next").classList.remove("btn-primary"),document.getElementById("next").classList.add("btn-success")):1===h?(showSkipButton(),document.getElementById("settings").classList.add("d-none"),a?(document.getElementById("buzz").disabled=!0,document.getElementById("next").disabled=!0,document.getElementById("pause").disabled=!0):!BLOCKED_TEAM_BUZZ&&(document.getElementById("buzz").disabled=!1,document.getElementById("pause").disabled=!1)):2===h?(showNextButton(),document.getElementById("settings").classList.add("d-none")):void 0;toggleLock({lock:j.lock}),toggleLoginRequired({loginRequired:j.loginRequired}),toggleRebuzz({rebuzz:j.rebuzz}),toggleSkip({skip:j.skip}),toggleTimer({timer:j.timer}),setReadingSpeed({readingSpeed:j.readingSpeed}),setStrictness({strictness:j.strictness}),j.controlled&&toggleControlled({controlled:j.controlled}),j.public&&togglePublic({public:j.public})}async function connectionAcknowledgedQuery({difficulties:j=[],minYear:a,maxYear:b,packetNumbers:k=[],powermarkOnly:c,setName:l="",standardOnly:d,alternateSubcategories:e,categories:f,subcategories:g,percentView:h,categoryPercents:i}){setDifficulties({difficulties:j}),document.getElementById("year-range-a").textContent=a,document.getElementById("year-range-b").textContent=b,document.getElementById("packet-number").value=arrayToRange(k),document.getElementById("toggle-powermark-only").checked=c,document.getElementById("set-name").value=l,""!==l&&0===room.setLength&&document.getElementById("set-name").classList.add("is-invalid"),document.getElementById("toggle-standard-only").checked=d,setCategories({categories:f,subcategories:g,alternateSubcategories:e,percentView:h,categoryPercents:i}),$(document).ready(function(){$("#slider").slider("values",0,a),$("#slider").slider("values",1,b)})}function connectionAcknowledgedTossup({tossup:a}){tossup=a,document.getElementById("set-name-info").textContent=tossup?.set?.name??"",document.getElementById("packet-number-info").textContent=tossup?.packet?.number??"-",document.getElementById("question-number-info").textContent=tossup?.number??"-"}function endOfSet(){window.alert("You have reached the end of the set")}function failedVotekickPoints({userId:a}){a===USER_ID&&window.alert("You can only votekick once you have answered a question correctly!")}function forceUsername({message:a,username:b}){window.alert(a),window.localStorage.setItem("multiplayer-username",b),document.querySelector("#username").value=b}async function giveAnswer({celerity:a,directive:b,directedPrompt:c,givenAnswer:d,perQuestionCelerity:e,score:f,tossup:g,userId:h,username:i}){document.getElementById("answer-input").value="",document.getElementById("answer-input-group").classList.add("d-none"),document.getElementById("answer-input").blur(),logGiveAnswer({directive:b,givenAnswer:d,username:i}),"prompt"===b&&c?logEventConditionally(i,`was prompted with "${c}"`):"prompt"===b?logEventConditionally(i,"was prompted"):logEventConditionally(i,`${0<f?"":"in"}correctly answered for ${f} points`),"prompt"===b&&h===USER_ID?(document.getElementById("answer-input-group").classList.remove("d-none"),document.getElementById("answer-input").focus(),document.getElementById("answer-input").placeholder=c?`Prompt: "${c}"`:"Prompt"):"prompt"!==b&&(document.getElementById("answer-input").placeholder="Enter answer",document.getElementById("next").disabled=!1,document.getElementById("pause").disabled=!1,"accept"===b&&(document.getElementById("buzz").disabled=!0,Array.from(document.getElementsByClassName("tuh")).forEach(a=>{a.textContent=parseInt(a.innerHTML)+1})),"reject"===b&&(console.log("t2"),console.log(BLOCKED_TEAM_BUZZ),document.getElementById("buzz").disabled=!document.getElementById("toggle-rebuzz").checked&&h===USER_ID||BLOCKED_TEAM_BUZZ),10<f?(players[h].powers++,"red"===players[h].team?RED_SCORE+=15:"blue"===players[h].team&&(BLUE_SCORE+=15),logEventConditionally(i,`on team "${players[h].team}" answered correctly, so their team will control the bonus.`)):10===f?(players[h].tens++,"red"===players[h].team?RED_SCORE+=10:"blue"===players[h].team&&(BLUE_SCORE+=10),logEventConditionally(i,`on team "${players[h].team}" answered correctly, so their team will control the bonus.`)):0>f&&(players[h].negs++,"red"===players[h].team?RED_SCORE-=5:"blue"===players[h].team&&(BLUE_SCORE-=5)),players[h].points+=f,players[h].tuh++,players[h].celerity=a,upsertPlayerItem(players[h],USER_ID,room.ownerId,socket,room.public,room.showingOffline,RED_SCORE,BLUE_SCORE),sortPlayerListGroup(PLAYER_TEAM)),"prompt"!==b&&h===USER_ID&&questionStats.recordTossup(g,0<f,f,e,!0),audio.soundEffects&&h===USER_ID&&("accept"===b&&10<f?audio.power.play():"accept"===b&&10===f?audio.correct.play():"reject"===b&&audio.incorrect.play())}function handleError({message:a}){socket.close(3e3),window.alert(a),window.location.href="/multiplayer"}function join({isNew:a,user:b,userId:c,username:d}){logEventConditionally(d,"joined the game");c===USER_ID||(a?(b.celerity=b.celerity.correct.average,upsertPlayerItem(b,USER_ID,room.ownerId,socket,room.public,room.showingOffline,RED_SCORE,BLUE_SCORE),sortPlayerListGroup(PLAYER_TEAM),players[c]=b):(players[c].online=!0,document.getElementById("points-"+c).classList.add("bg-success"),document.getElementById("points-"+c).classList.remove("bg-secondary")))}function joinTeam({isNew:a,user:b,userId:c,username:d,team:e}){logEventConditionally(d,"joined the game on "+e);c===USER_ID||(a?(b.celerity=b.celerity.correct.average,upsertPlayerItem(b,USER_ID,room.ownerId,socket,room.public,room.showingOffline,RED_SCORE,BLUE_SCORE),sortPlayerListGroup(PLAYER_TEAM),players[c]=b):(players[c].online=!0,upsertPlayerItem(b,USER_ID,room.ownerId,socket,room.public,room.showingOffline,RED_SCORE,BLUE_SCORE),sortPlayerListGroup(PLAYER_TEAM),document.getElementById("points-"+c).classList.add("bg-success"),document.getElementById("points-"+c).classList.remove("bg-secondary")))}function leave({userId:a,username:b}){logEventConditionally(b,"left the game"),players[a].online=!1,upsertPlayerItem(players[a],USER_ID,room.ownerId,socket,room.public,room.showingOffline,RED_SCORE,BLUE_SCORE)}/**
 * Log the event, but only if `username !== undefined`.
 * If username is undefined, do nothing, regardless of the value of message.
 * @param {string | undefined} username
 * @param {string | undefined} message
 */function logEventConditionally(a,b){if(void 0!==a){const c=document.createElement("span");c.textContent=a;const d=document.createElement("span");d.textContent=b;const e=document.createElement("i");e.appendChild(c),e.appendChild(document.createTextNode(" ")),e.appendChild(d);const f=document.createElement("li");f.appendChild(e),document.getElementById("room-history").prepend(f)}}function logGiveAnswer({directive:d=null,givenAnswer:a,username:c}){const e=document.createElement("span");switch(e.textContent="Buzz",d){case"accept":e.className="badge text-dark bg-success";break;case"reject":e.className="badge text-light bg-danger";break;case"prompt":e.className="badge text-dark bg-warning";break;default:e.className="badge text-light bg-primary"}const f=document.createElement("b");f.textContent=c;const b=document.createElement("span");b.textContent=a;let g;if(document.getElementById("live-buzz")?(g=document.getElementById("live-buzz"),g.textContent=""):(g=document.createElement("li"),g.id="live-buzz",document.getElementById("room-history").prepend(g)),g.appendChild(e),g.appendChild(document.createTextNode(" ")),g.appendChild(f),g.appendChild(document.createTextNode(" ")),g.appendChild(b),"accept"===d||"reject"===d){const a=document.createElement("span");a.className=e.className,"accept"===d?a.textContent="Correct":"reject"===d&&(a.textContent="Incorrect"),g.appendChild(document.createTextNode(" ")),g.appendChild(a)}d&&(g.id="")}function lostBuzzerRace({username:a,userId:b}){logEventConditionally(a,"lost the buzzer race"),b===USER_ID&&document.getElementById("answer-input-group").classList.add("d-none")}function mutePlayer({targetId:a,targetUsername:b,muteStatus:c}){"Mute"===c?!room.muteList.includes(a)&&(room.muteList.push(a),logEventConditionally(b,"was muted")):room.muteList.includes(a)&&(room.muteList=room.muteList.filter(b=>b!==a),logEventConditionally(b,"was unmuted"))}function next({packetLength:a,oldTossup:b,tossup:c,type:d,username:e}){logEventConditionally(e,{end:"ended the game",next:"went to the next question",skip:"skipped the question",start:"started the game"}[d]),"start"===d&&(document.getElementById("next").classList.add("btn-primary"),document.getElementById("next").classList.remove("btn-success"),document.getElementById("next").textContent="Next"),"start"!==d&&createTossupCard(b),document.getElementById("answer").textContent="",document.getElementById("question").textContent="",document.getElementById("settings").classList.add("d-none"),"end"===d?(document.getElementById("buzz").disabled=!0,document.getElementById("next").classList.remove("btn-primary"),document.getElementById("next").classList.add("btn-success"),document.getElementById("next").textContent="Start"):(tossup=c,document.getElementById("buzz").textContent="Buzz",console.log("t5"),document.getElementById("buzz").disabled=!1,console.log("recove"),document.getElementById("packet-length-info").textContent=room.mode===MODE_ENUM.SET_NAME?a:"-",document.getElementById("packet-number-info").textContent=tossup?.packet.number??"-",document.getElementById("pause").textContent="Pause",document.getElementById("pause").disabled=!1,document.getElementById("question-number-info").textContent=tossup?.number??"-",document.getElementById("set-name-info").textContent=tossup?.set.name??""),showSkipButton(),updateTimerDisplay(100),BLOCKED_TEAM_BUZZ=!1}function noQuestionsFound(){window.alert("No questions found")}function ownerChange({newOwner:a}){players[a]?(room.ownerId=a,logEventConditionally(players[a].username,"became the room owner")):logEventConditionally(a,"became the room owner"),Object.keys(players).forEach(a=>{upsertPlayerItem(players[a],USER_ID,room.ownerId,socket,room.public,room.showingOffline,RED_SCORE,BLUE_SCORE)}),document.getElementById("toggle-controlled").disabled=room.public||room.ownerId!==USER_ID}function pause({paused:a,username:b}){logEventConditionally(b,`${a?"":"un"}paused the game`),document.getElementById("pause").textContent=a?"Resume":"Pause"}function revealAnswer({answer:a,question:b}){document.getElementById("question").innerHTML=b,document.getElementById("answer").innerHTML="ANSWER: "+a,document.getElementById("pause").disabled=!0,showNextButton(),BLOCKED_TEAM_BUZZ=!1}function setCategories({alternateSubcategories:a,categories:b,subcategories:c,percentView:d,categoryPercents:e,username:f}){logEventConditionally(f,"updated the categories"),categoryManager.import({categories:b,subcategories:c,alternateSubcategories:a,percentView:d,categoryPercents:e});document.getElementById("category-modal")&&categoryManager.loadCategoryModal()}function setDifficulties({difficulties:a,username:b=void 0}){return b&&logEventConditionally(b,0<a.length?`set the difficulties to ${a}`:"cleared the difficulties"),document.getElementById("difficulties")?void Array.from(document.getElementById("difficulties").children).forEach(b=>{const c=b.querySelector("input");a.includes(parseInt(c.value))?(c.checked=!0,b.classList.add("active")):(c.checked=!1,b.classList.remove("active"))}):void(room.difficulties=a)}function setMode({mode:a,setName:b,username:c}){c&&logEventConditionally(c,"changed the mode to "+a),room.mode=a;a===MODE_ENUM.SET_NAME?(document.getElementById("difficulty-settings").classList.add("d-none"),document.getElementById("set-name").textContent=b,document.getElementById("set-settings").classList.remove("d-none"),document.getElementById("toggle-powermark-only").disabled=!0,document.getElementById("toggle-standard-only").disabled=!0):a===MODE_ENUM.RANDOM?(document.getElementById("difficulty-settings").classList.remove("d-none"),document.getElementById("set-settings").classList.add("d-none"),document.getElementById("toggle-powermark-only").disabled=!1,document.getElementById("toggle-standard-only").disabled=!1):void 0;document.getElementById("set-mode").value=a}function setPacketNumbers({username:a,packetNumbers:b}){b=arrayToRange(b),logEventConditionally(a,0<b.length?`changed packet numbers to ${b}`:"cleared packet numbers"),document.getElementById("packet-number").value=b}function setReadingSpeed({username:a,readingSpeed:b}){logEventConditionally(a,`changed the reading speed to ${b}`),document.getElementById("reading-speed").value=b,document.getElementById("reading-speed-display").textContent=b}function setStrictness({strictness:a,username:b}){logEventConditionally(b,`changed the strictness to ${a}`),document.getElementById("set-strictness").value=a,document.getElementById("strictness-display").textContent=a}function setSetName({username:a,setName:b,setLength:c}){logEventConditionally(a,0<b.length?`changed set name to ${b}`:"cleared set name"),document.getElementById("set-name").value=b;// make border red if set name is not in set list
const d=!b||api.getSetList().includes(b);room.setLength=c,document.getElementById("packet-number").placeholder="Packet Numbers"+(room.setLength?` (1-${room.setLength})`:""),document.getElementById("set-name").classList.toggle("is-invalid",!d)}function setUsername({oldUsername:a,newUsername:b,userId:c}){logEventConditionally(a,`changed their username to ${b}`),document.getElementById("username-"+c).textContent=b,players[c].username=b,sortPlayerListGroup(PLAYER_TEAM),c===USER_ID&&(username=b,window.localStorage.setItem("multiplayer-username",username),document.getElementById("username").value=username),upsertPlayerItem(players[c],USER_ID,room.ownerId,socket,room.public,room.showingOffline,RED_SCORE,BLUE_SCORE)}function setYearRange({minYear:a,maxYear:b,username:c}){c&&logEventConditionally(c,`changed the year range to ${a}-${b}`),$("#slider").slider("values",0,a),$("#slider").slider("values",1,b),document.getElementById("year-range-a").textContent=a,document.getElementById("year-range-b").textContent=b}function showNextButton(){document.getElementById("next").classList.remove("d-none"),document.getElementById("next").disabled=!1,document.getElementById("skip").classList.add("d-none"),document.getElementById("skip").disabled=!0}function showSkipButton(){document.getElementById("skip").classList.remove("d-none"),document.getElementById("skip").disabled=!document.getElementById("toggle-skip").checked,document.getElementById("next").classList.add("d-none"),document.getElementById("next").disabled=!0}function sortPlayerListGroup(a,c=!0){if(null!==a){{const a=document.getElementById("redPlayers"),b=Array.from(a.children),d=11;b.sort((e,a)=>{const b=parseInt(document.getElementById("points-"+e.id.substring(d)).innerHTML),f=parseInt(document.getElementById("points-"+a.id.substring(d)).innerHTML);// if points are equal, sort alphabetically by username
if(b===f){const b=document.getElementById("username-"+e.id.substring(d)).innerHTML,f=document.getElementById("username-"+a.id.substring(d)).innerHTML;return c?b.localeCompare(f):f.localeCompare(b)}return c?f-b:b-f}).forEach(b=>{a.appendChild(b)})}{const a=document.getElementById("bluePlayers"),b=Array.from(a.children),d=11;b.sort((e,a)=>{const b=parseInt(document.getElementById("points-"+e.id.substring(d)).innerHTML),f=parseInt(document.getElementById("points-"+a.id.substring(d)).innerHTML);// if points are equal, sort alphabetically by username
if(b===f){const b=document.getElementById("username-"+e.id.substring(d)).innerHTML,f=document.getElementById("username-"+a.id.substring(d)).innerHTML;return c?b.localeCompare(f):f.localeCompare(b)}return c?f-b:b-f}).forEach(b=>{a.appendChild(b)})}}else{const a=document.getElementById("player-list-group"),b=Array.from(a.children),d=11;b.sort((e,a)=>{const b=parseInt(document.getElementById("points-"+e.id.substring(d)).innerHTML),f=parseInt(document.getElementById("points-"+a.id.substring(d)).innerHTML);// if points are equal, sort alphabetically by username
if(b===f){const b=document.getElementById("username-"+e.id.substring(d)).innerHTML,f=document.getElementById("username-"+a.id.substring(d)).innerHTML;return c?b.localeCompare(f):f.localeCompare(b)}return c?f-b:b-f}).forEach(b=>{a.appendChild(b)})}}function teamChange({user:a,username:b,newTeam:c,newRscore:d,newBscore:e}){logEventConditionally(b,`switched teams to ${c}`),players[a].team=c,a===USER_ID?(console.log("reassigning team"),PLAYER_TEAM=c):console.log("not reassigning team"),RED_SCORE=d,BLUE_SCORE=e,Object.values(players).forEach(a=>upsertPlayerItem(a,USER_ID,room.ownerId,socket,room.public,room.showingOffline,RED_SCORE,BLUE_SCORE))}function toggleControlled({controlled:a,username:b}){logEventConditionally(b,`${a?"enabled":"disabled"} controlled mode`),document.getElementById("toggle-controlled").checked=a,document.getElementById("controlled-room-warning").classList.toggle("d-none",!a),document.getElementById("toggle-public").disabled=a,a=a&&USER_ID!==room.ownerId,document.getElementById("toggle-lock").disabled=a,document.getElementById("toggle-login-required").disabled=a,document.getElementById("toggle-timer").disabled=a,document.getElementById("toggle-powermark-only").disabled=a,document.getElementById("toggle-rebuzz").disabled=a,document.getElementById("toggle-skip").disabled=a,document.getElementById("toggle-standard-only").disabled=a,document.getElementById("category-select-button").disabled=a,document.getElementById("reading-speed").disabled=a,document.getElementById("set-mode").disabled=a,document.getElementById("set-strictness").disabled=a}function toggleLock({lock:a,username:b}){logEventConditionally(b,`${a?"locked":"unlocked"} the room`),document.getElementById("toggle-lock").checked=a}function toggleLoginRequired({loginRequired:a,username:b}){logEventConditionally(b,`${a?"enabled":"disabled"} require players to be logged in`),document.getElementById("toggle-login-required").checked=a}function togglePowermarkOnly({powermarkOnly:a,username:b}){logEventConditionally(b,`${a?"enabled":"disabled"} powermark only`),document.getElementById("toggle-powermark-only").checked=a}function toggleRebuzz({rebuzz:a,username:b}){logEventConditionally(b,`${a?"enabled":"disabled"} multiple buzzes (effective next question)`),document.getElementById("toggle-rebuzz").checked=a}function toggleSkip({skip:a,username:b}){logEventConditionally(b,`${a?"enabled":"disabled"} skipping`),document.getElementById("toggle-skip").checked=a,document.getElementById("skip").disabled=!a||document.getElementById("skip").classList.contains("d-none")}function toggleStandardOnly({standardOnly:a,username:b}){logEventConditionally(b,`${a?"enabled":"disabled"} standard format only`),document.getElementById("toggle-standard-only").checked=a}function toggleTimer({timer:a,username:b}){logEventConditionally(b,`${a?"enabled":"disabled"} the timer`),document.getElementById("toggle-timer").checked=a,document.getElementById("timer").classList.toggle("d-none",!a)}function togglePublic({public:a,username:b}){logEventConditionally(b,`made the room ${a?"public":"private"}`),document.getElementById("chat").disabled=a,document.getElementById("toggle-controlled").disabled=a||room.ownerId!==USER_ID,document.getElementById("toggle-lock").disabled=a,document.getElementById("toggle-login-required").disabled=a,document.getElementById("toggle-public").checked=a,document.getElementById("toggle-timer").disabled=a,room.public=a,a&&(document.getElementById("toggle-lock").checked=!1,document.getElementById("toggle-login-required").checked=!1,toggleTimer({timer:!0})),Object.keys(players).forEach(a=>{upsertPlayerItem(players[a],USER_ID,room.ownerId,socket,room.public,room.showingOffline,RED_SCORE,BLUE_SCORE)})}function updateQuestion({word:a}){"(*)"===a||"[*]"===a||(document.getElementById("question").innerHTML+=a+" ")}function updateTimerDisplay(a){const b=Math.floor(a/10);document.querySelector(".timer .face").textContent=b,document.querySelector(".timer .fraction").textContent="."+a%10}function vkInit({targetUsername:a,threshold:b}){logEventConditionally(`A votekick has been started against user ${a} and needs ${b} votes to succeed.`)}function vkHandle({targetUsername:a,targetId:b}){USER_ID===b?(window.alert("You were vote kicked from this room by others."),setTimeout(()=>{window.location.replace("../")},100)):logEventConditionally(a+" has been vote kicked from this room.")}document.getElementById("answer-form").addEventListener("submit",function(a){a.preventDefault(),a.stopPropagation();const b=document.getElementById("answer-input").value;socket.send(JSON.stringify({type:"give-answer",givenAnswer:b}))}),document.getElementById("answer-input").addEventListener("input",function(){socket.send(JSON.stringify({type:"give-answer-live-update",givenAnswer:this.value}))}),document.getElementById("buzz").addEventListener("click",function(){this.blur(),audio.soundEffects&&audio.buzz.play(),socket.send(JSON.stringify({type:"buzz"})),socket.send(JSON.stringify({type:"give-answer-live-update",givenAnswer:""}))}),document.getElementById("switch-team").addEventListener("click",function(){this.blur(),audio.soundEffects&&audio.buzz.play(),console.log("My current team is "),console.log(PLAYER_TEAM),console.log("the players are"),console.log(players),socket.send(JSON.stringify({type:"change-team",curTeam:PLAYER_TEAM}))}),document.getElementById("chat").addEventListener("click",function(){this.blur(),document.getElementById("chat-input-group").classList.remove("d-none"),document.getElementById("chat-input").focus(),socket.send(JSON.stringify({type:"chat-live-update",message:""}))}),document.getElementById("chat-form").addEventListener("submit",function(a){a.preventDefault(),a.stopPropagation();const b=document.getElementById("chat-input").value;document.getElementById("chat-input").value="",document.getElementById("chat-input-group").classList.add("d-none"),document.getElementById("chat-input").blur(),socket.send(JSON.stringify({type:"chat",message:b}))}),document.getElementById("chat-input").addEventListener("input",function(){socket.send(JSON.stringify({type:"chat-live-update",message:this.value}))}),document.getElementById("clear-stats").addEventListener("click",function(){this.blur(),socket.send(JSON.stringify({type:"clear-stats"}))}),document.getElementById("next").addEventListener("click",function(){switch(this.blur(),this.innerHTML){case"Start":socket.send(JSON.stringify({type:"start"}));break;case"Next":socket.send(JSON.stringify({type:"next"}))}}),document.getElementById("skip").addEventListener("click",function(){this.blur(),socket.send(JSON.stringify({type:"skip"}))}),document.getElementById("packet-number").addEventListener("change",function(){const a=rangeToArray(this.value,room.setLength);return a.some(a=>1>a||a>room.setLength)?void document.getElementById("packet-number").classList.add("is-invalid"):void(document.getElementById("packet-number").classList.remove("is-invalid"),socket.send(JSON.stringify({type:"set-packet-numbers",packetNumbers:a})))}),document.getElementById("pause").addEventListener("click",function(){this.blur();const a=parseFloat(document.querySelector(".timer .face").textContent),b=parseFloat(document.querySelector(".timer .fraction").textContent);socket.send(JSON.stringify({type:"pause",pausedTime:10*(a+b)}))}),document.getElementById("reading-speed").addEventListener("change",function(){socket.send(JSON.stringify({type:"set-reading-speed",readingSpeed:this.value}))}),document.getElementById("reading-speed").addEventListener("input",function(){document.getElementById("reading-speed-display").textContent=this.value}),document.getElementById("report-question-submit").addEventListener("click",function(){api.reportQuestion(document.getElementById("report-question-id").value,document.getElementById("report-question-reason").value,document.getElementById("report-question-description").value)}),document.getElementById("set-name").addEventListener("change",async function(){socket.send(JSON.stringify({type:"set-set-name",setName:this.value}))}),document.getElementById("set-strictness").addEventListener("change",function(){this.blur(),socket.send(JSON.stringify({type:"set-strictness",strictness:this.value}))}),document.getElementById("set-strictness").addEventListener("input",function(){document.getElementById("strictness-display").textContent=this.value}),document.getElementById("toggle-offline-players").addEventListener("click",function(){room.showingOffline=this.checked,this.blur(),Object.values(players).forEach(a=>upsertPlayerItem(a,USER_ID,room.ownerId,socket,room.public,room.showingOffline,RED_SCORE,BLUE_SCORE))}),document.getElementById("toggle-controlled").addEventListener("click",function(){this.blur(),socket.send(JSON.stringify({type:"toggle-controlled",controlled:this.checked}))}),document.getElementById("toggle-lock").addEventListener("click",function(){this.blur(),socket.send(JSON.stringify({type:"toggle-lock",lock:this.checked}))}),document.getElementById("toggle-login-required").addEventListener("click",function(){this.blur(),socket.send(JSON.stringify({type:"toggle-login-required",loginRequired:this.checked}))}),document.getElementById("toggle-powermark-only").addEventListener("click",function(){this.blur(),socket.send(JSON.stringify({type:"toggle-powermark-only",powermarkOnly:this.checked}))}),document.getElementById("toggle-rebuzz").addEventListener("click",function(){this.blur(),socket.send(JSON.stringify({type:"toggle-rebuzz",rebuzz:this.checked}))}),document.getElementById("toggle-skip").addEventListener("click",function(){this.blur(),socket.send(JSON.stringify({type:"toggle-skip",skip:this.checked}))}),document.getElementById("set-mode").addEventListener("change",function(){this.blur(),socket.send(JSON.stringify({type:"set-mode",setName:document.getElementById("set-name").value,mode:this.value}))}),document.getElementById("toggle-settings").addEventListener("click",function(){this.blur(),document.getElementById("buttons").classList.toggle("col-lg-9"),document.getElementById("buttons").classList.toggle("col-lg-12"),document.getElementById("content").classList.toggle("col-lg-9"),document.getElementById("content").classList.toggle("col-lg-12"),document.getElementById("settings").classList.toggle("d-none"),document.getElementById("settings").classList.toggle("d-lg-none")}),document.getElementById("toggle-standard-only").addEventListener("click",function(){this.blur(),socket.send(JSON.stringify({type:"toggle-standard-only",standardOnly:this.checked}))}),document.getElementById("toggle-timer").addEventListener("click",function(){this.blur(),socket.send(JSON.stringify({type:"toggle-timer",timer:this.checked}))}),document.getElementById("toggle-public").addEventListener("click",function(){this.blur(),socket.send(JSON.stringify({type:"toggle-public",public:this.checked}))}),document.getElementById("username").addEventListener("change",function(){socket.send(JSON.stringify({type:"set-username",userId:USER_ID,username:this.value})),username=this.value,window.localStorage.setItem("multiplayer-username",username)}),document.getElementById("year-range-a").onchange=function(){const[a,b]=$("#slider").slider("values");if(b<a)return void(document.querySelector("#yearRangeAlert").style.display="");document.querySelector("#yearRangeAlert").style.display="none";socket.send(JSON.stringify({type:"set-year-range",minYear:a,maxYear:b}))},document.addEventListener("keydown",a=>{if("Escape"===a.key&&"chat-input"===document.activeElement.id&&(document.getElementById("chat-input").value="",document.getElementById("chat-input-group").classList.add("d-none"),document.getElementById("chat-input").blur(),socket.send(JSON.stringify({type:"chat",message:""}))),!["INPUT","TEXTAREA","SELECT"].includes(document.activeElement.tagName))switch(a.key?.toLowerCase()){case" ":document.getElementById("buzz").click(),a.target===document.body&&a.preventDefault();break;case"e":return document.getElementById("toggle-settings").click();case"k":return document.getElementsByClassName("card-header-clickable")[0].click();case"p":return document.getElementById("pause").click();case"t":return document.getElementsByClassName("star-tossup")[0].click();case"y":return navigator.clipboard.writeText(tossup._id??"");case"n":case"s":document.getElementById("next").click(),document.getElementById("skip").click()}}),document.addEventListener("keypress",function(a){"Enter"===a.key&&a.target===document.body&&document.getElementById("chat").click()}),document.getElementById("username").value=username,ReactDOM.createRoot(document.getElementById("category-modal-root")).render(/*#__PURE__*/React.createElement(CategoryModal,{categoryManager:categoryManager,onClose:()=>{oldCategories!==JSON.stringify(categoryManager.export())&&socket.send(JSON.stringify({type:"set-categories",...categoryManager.export()})),oldCategories=JSON.stringify(categoryManager.export())}})),ReactDOM.createRoot(document.getElementById("difficulty-dropdown-root")).render(/*#__PURE__*/React.createElement(DifficultyDropdown,{startingDifficulties:room.difficulties,onChange:()=>socket.send(JSON.stringify({type:"set-difficulties",difficulties:getDropdownValues("difficulties")}))}));
